const API_URL = 'http://localhost:5000/api';

const categoriesEl = document.getElementById("categories");
const treesEl = document.getElementById("trees");
const cartItemsEl = document.getElementById("cart-items");
const cartTotalEl = document.getElementById("cart-total");
const modal = document.getElementById("plant-modal");
const spinner = document.getElementById("spinner");

const loginModal = document.getElementById("login-modal");
const signupModal = document.getElementById("signup-modal");
const ordersModal = document.getElementById("orders-modal");

document.getElementById("close-modal").onclick = () => modal.classList.add("hidden");
document.getElementById("close-login").onclick = () => loginModal.classList.add("hidden");
document.getElementById("close-signup").onclick = () => signupModal.classList.add("hidden");
document.getElementById("close-orders").onclick = () => ordersModal.classList.add("hidden");

document.getElementById("show-signup").onclick = (e) => {
    e.preventDefault();
    loginModal.classList.add("hidden");
    signupModal.classList.remove("hidden");
};
document.getElementById("show-login").onclick = (e) => {
    e.preventDefault();
    signupModal.classList.add("hidden");
    loginModal.classList.remove("hidden");
};

document.getElementById("login-form").onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById("login-email").value;
    const password = document.getElementById("login-password").value;

    try {
        const res = await fetch(`${API_URL}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (res.ok) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('user', JSON.stringify(data.user));
            alert('Login Successful');
            loginModal.classList.add("hidden");
            checkAuth();
        } else {
            alert(data.error);
        }
    } catch (err) {
        console.error(err);
        alert('Login failed');
    }
};

document.getElementById("signup-form").onsubmit = async (e) => {
    e.preventDefault();
    const name = document.getElementById("signup-name").value;
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;

    try {
        const res = await fetch(`${API_URL}/auth/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, email, password })
        });
        if (res.ok) {
            alert('Signup Successful! Please Login.');
            signupModal.classList.add("hidden");
            loginModal.classList.remove("hidden");
        } else {
            const data = await res.json();
            alert(data.error);
        }
    } catch (err) {
        console.error(err);
        alert('Signup failed');
    }
};

function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('user');
    checkAuth();
    alert('Logged out');
}

function checkAuth() {
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');

    if (token && user) {
        document.getElementById('nav-login').classList.add('hidden');
        document.getElementById('nav-signup').classList.add('hidden');
        document.getElementById('nav-orders').classList.remove('hidden');
        document.getElementById('nav-logout').classList.remove('hidden');

        const userEl = document.getElementById('nav-user');
        userEl.textContent = `Hi, ${user.name}`;
        userEl.classList.remove('hidden');

        if (user.role === 'admin') {
            document.getElementById('nav-admin').classList.remove('hidden');
        } else {
            document.getElementById('nav-admin').classList.add('hidden');
        }
    } else {
        document.getElementById('nav-login').classList.remove('hidden');
        document.getElementById('nav-signup').classList.remove('hidden');
        document.getElementById('nav-orders').classList.add('hidden');
        document.getElementById('nav-logout').classList.add('hidden');
        document.getElementById('nav-user').classList.add('hidden');
        document.getElementById('nav-admin').classList.add('hidden');
    }
    renderCart();
}

let cart = [];
let selectedCategoryBtn = null;
let allTrees = [];

function highlightCategory(btn) {
    if (selectedCategoryBtn) {
        selectedCategoryBtn.classList.remove("bg-green-600", "text-white");
        selectedCategoryBtn.classList.add("bg-green-100");
    }
    btn.classList.add("bg-green-600", "text-white");
    btn.classList.remove("bg-green-100");
    selectedCategoryBtn = btn;
}

const categories = [
    "All Trees", "Fruit Tree", "Flowering Tree", "Shade Tree",
    "Medicinal Tree", "Timber Tree", "Evergreen Tree", "Ornamental Plant",
    "Bamboo", "Climber", "Aquatic Plant"
];

function loadCategories() {
    categoriesEl.innerHTML = "";
    categories.forEach((cat, index) => {
        const btn = document.createElement("button");
        btn.textContent = cat;
        btn.className = "px-4 py-2 rounded-lg w-full text-left bg-green-100 hover:bg-green-200";
        btn.onclick = () => {
            highlightCategory(btn);
            loadTrees(cat);
        };
        categoriesEl.appendChild(btn);
        if (index === 0) highlightCategory(btn);
    });
}

function getInvolved() {
    document.getElementById('login-modal').classList.remove('hidden');
}

async function loadTrees(categoryName = "All Trees") {
    try {
        spinner.classList.remove("hidden");
        if (allTrees.length === 0) {
            const res = await fetch("https://openapi.programming-hero.com/api/plants");
            const data = await res.json();
            allTrees = data.data || data.plants || [];
        }

        let filtered = allTrees;
        if (categoryName !== "All Trees") {
            filtered = allTrees.filter(tree => tree.category === categoryName);
        }

        treesEl.innerHTML = "";
        filtered.forEach(tree => {
            const card = document.createElement("div");
            card.className = "bg-white rounded-xl shadow p-4 flex flex-col";
            card.innerHTML = `
        <img src="${tree.image}" alt="${tree.name}" class="w-full h-40 object-cover rounded-lg mb-3">
        <h4 class="font-semibold cursor-pointer hover:text-green-700">${tree.name}</h4>
        <p class="text-sm text-gray-600 mb-2">${tree.description ? tree.description.slice(0, 60) : ''}...</p>
        <div class="flex justify-between items-center mb-2">
          <span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs">${tree.category}</span>
          <span class="font-bold">৳${tree.price}</span>
        </div>
        <button class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 mt-auto">Add to Cart</button>
      `;
            card.querySelector("button").onclick = () => addToCart(tree);
            card.querySelector("h4").onclick = () => showPlantDetail(tree);
            treesEl.appendChild(card);
        });

    } catch (err) {
        console.error("Error loading trees", err);
    } finally {
        spinner.classList.add("hidden");
    }
}

function showPlantDetail(tree) {
    document.getElementById("modal-img").src = tree.image;
    document.getElementById("modal-name").textContent = tree.name;
    document.getElementById("modal-category").textContent = `Category: ${tree.category}`;
    document.getElementById("modal-desc").textContent = tree.description || "No description available";
    document.getElementById("modal-price").textContent = `Price: ৳${tree.price}`;
    modal.classList.remove("hidden");
}

function addToCart(tree) {
    const existing = cart.find(item => item.id === tree.id);
    if (existing) {
        existing.qty++;
    } else {
        cart.push({ ...tree, qty: 1 });
    }
    renderCart();
}

function removeFromCart(id) {
    cart = cart.filter(item => item.id !== id);
    renderCart();
}

function renderCart() {
    cartItemsEl.innerHTML = "";
    let total = 0;
    cart.forEach(item => {
        total += item.price * item.qty;
        const li = document.createElement("li");
        li.className = "flex justify-between items-center bg-green-50 px-3 py-2 rounded-lg";
        li.innerHTML = `
      <div>
        <p class="font-semibold">${item.name}</p>
        <p class="text-sm text-gray-600">৳${item.price} × ${item.qty}</p>
      </div>
      <button onclick="removeFromCart(${item.id})" class="text-red-500 font-bold text-lg">×</button>
    `;
        cartItemsEl.appendChild(li);
    });
    cartTotalEl.textContent = `৳${total}`;

    const placeOrderBtn = document.createElement('button');
    placeOrderBtn.className = "w-full mt-4 bg-yellow-400 font-bold py-2 rounded text-green-900 hover:bg-yellow-500";

    if (cart.length === 0) {
        placeOrderBtn.textContent = "Cart is Empty";
        placeOrderBtn.disabled = true;
        placeOrderBtn.classList.add("opacity-50", "cursor-not-allowed");
    } else {
        const token = localStorage.getItem('token');
        if (token) {
            placeOrderBtn.textContent = "Place Order (Demo Pay)";
            placeOrderBtn.onclick = placeOrder;
        } else {
            placeOrderBtn.textContent = "Login to Order";
            placeOrderBtn.onclick = () => document.getElementById('login-modal').classList.remove('hidden');
        }
    }
    cartItemsEl.appendChild(placeOrderBtn);
}

async function placeOrder() {
    if (!confirm("Proceed with Demo Payment?")) return;

    const token = localStorage.getItem('token');
    const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
    const items = cart.map(item => ({
        name: item.name,
        price: item.price,
        qty: item.qty,
        id: item.id
    }));

    try {
        const res = await fetch(`${API_URL}/orders`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ items, totalAmount })
        });

        if (res.ok) {
            alert("Order Placed Successfully! Paid via Demo.");
            cart = [];
            renderCart();
            showMyOrders();
        } else {
            alert("Order Failed");
        }
    } catch (err) {
        console.error(err);
        alert("Error placing order");
    }
}

async function showMyOrders() {
    const token = localStorage.getItem('token');
    if (!token) return;

    ordersModal.classList.remove('hidden');
    const list = document.getElementById('orders-list');
    list.innerHTML = '<p class="text-center text-gray-500">Loading...</p>';

    try {
        const res = await fetch(`${API_URL}/orders/my-orders`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const orders = await res.json();

        if (orders.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-500">No orders found.</p>';
            return;
        }

        list.innerHTML = "";
        orders.forEach(order => {
            const div = document.createElement('div');
            div.className = "bg-green-50 p-4 rounded-lg border border-green-200";

            let statusColor = 'text-yellow-600';
            if (order.status === 'Approved') statusColor = 'text-green-600';
            if (order.status === 'Rejected') statusColor = 'text-red-600';

            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold">Order #${order._id.slice(-6)}</span>
                    <span class="font-bold ${statusColor}">${order.status}</span>
                </div>
                 <p class="text-sm text-gray-600 mb-2">Date: ${new Date(order.createdAt).toLocaleDateString()}</p>
                <ul class="text-sm space-y-1 bg-white p-2 rounded">
                    ${order.items.map(i => `<li>${i.name} (x${i.qty}) - ৳${i.price * i.qty}</li>`).join('')}
                </ul>
                <p class="mt-2 font-bold text-right">Total: ৳${order.totalAmount}</p>
            `;
            list.appendChild(div);
        });
    } catch (err) {
        console.error(err);
        list.innerHTML = '<p class="text-center text-red-500">Failed to load orders.</p>';
    }
}

window.onload = () => {
    checkAuth();
    loadCategories();
    loadTrees();
};
